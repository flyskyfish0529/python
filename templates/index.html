<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½ç›‘æ§ç»ˆç«¯</title>
    <style>
        :root {
            --bg-color: #121212;
            --panel-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-sec: #b0b0b0;
            --accent: #007bff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢å‡ºç°æ»šåŠ¨æ¡ */
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        h2 { margin: 0; letter-spacing: 1px; }

        /* ä¸»å¸ƒå±€ï¼šå·¦å³ä¸¤æ  */
        .main-layout {
            display: flex;
            gap: 20px;
            flex: 1; /* å æ»¡å‰©ä½™é«˜åº¦ */
            overflow: hidden;
        }

        /* --- å·¦ä¾§é¢æ¿ï¼šè§†é¢‘ + æ§åˆ¶ + æ—¥å¿— --- */
        .left-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 0; /* é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º */
        }

        /* æ§åˆ¶æ  */
        .controls {
            background: #2a2a2a;
            padding: 10px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
            border: 1px solid #444;
            flex-shrink: 0;
        }

        button {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.8; }
        .btn-upload { background: var(--accent); color: white; }
        .btn-reset { background: #444; color: white; border: 1px solid #666; }

        /* è§†é¢‘æ˜¾ç¤ºåŒº */
        .video-box {
            background: #000;
            border-radius: 8px;
            border: 2px solid #333;
            position: relative;
            flex-grow: 0;
            height: 55%; /* å æ®å·¦ä¾§é«˜åº¦çš„ 55% */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .video-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* æ•°æ®ç»Ÿè®¡æ¡ */
        .stats-bar {
            display: flex;
            gap: 20px;
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 8px;
            justify-content: space-around;
            border: 1px solid #333;
            flex-shrink: 0;
        }
        .stat-item { font-size: 0.9rem; color: var(--text-sec); }
        .stat-item span { font-size: 1.4rem; font-weight: bold; color: var(--accent); margin-left: 5px; }

        /* é€šè¡Œæ—¥å¿—åŒº */
        .log-panel {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 10px;
            flex: 1; /* å æ®å·¦ä¾§å‰©ä½™çš„æ‰€æœ‰ç©ºé—´ */
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .log-header {
            display: flex;
            justify-content: space-between;
            color: var(--success);
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 8px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        .log-list {
            overflow-y: auto;
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .log-item {
            padding: 4px 0;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            justify-content: space-between;
        }
        .log-name { color: #fff; }
        .log-time { color: #666; }

        /* --- å³ä¾§é¢æ¿ï¼šé™Œç”Ÿäººå¾…å¤„ç† --- */
        .right-panel {
            flex: 1;
            background: #1a1a1a;
            border-left: 1px solid #333;
            padding: 15px;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            min-width: 250px;
        }

        .panel-title {
            color: var(--warning);
            font-size: 1rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            font-weight: bold;
        }

        .pending-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        /* é™Œç”Ÿäººå¡ç‰‡æ ·å¼ */
        .stranger-card {
            background: #2c2c2c;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #444;
            animation: fadeIn 0.4s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .stranger-card img {
            width: 100%;
            height: 120px;
            object-fit: cover; /* ä¿æŒå¡«å……ï¼Œå¯èƒ½è£å‰ª */
            object-position: top; /* èšç„¦å¤´éƒ¨ */
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #555;
            cursor: zoom-in;
        }

        .stranger-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }

        .stranger-card input {
            width: 100%;
            padding: 6px;
            margin-bottom: 8px;
            background: #111;
            border: 1px solid #555;
            color: white;
            border-radius: 3px;
            box-sizing: border-box;
        }
        .stranger-card input:focus { outline: none; border-color: var(--accent); }

        .btn-group { display: flex; gap: 5px; }
        .btn-group button { flex: 1; font-size: 0.8rem; padding: 5px; }
        .btn-confirm { background: var(--success); color: white; }
        .btn-delete { background: var(--danger); color: white; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

    </style>
</head>
<body>

    <header>
        <h2>AI æ™ºèƒ½ç›‘æ§ç»ˆç«¯ <span style="font-size: 0.8rem; color: #666; font-weight: normal;">(YOLOv8 + FaceNet)</span></h2>
    </header>

    <div class="main-layout">

        <div class="left-panel">

            <div class="controls">
                <form id="uploadForm" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center; margin: 0;">
                    <input type="file" name="file" accept="video/*" style="color: #ccc; font-size: 0.9rem;">
                    <button type="submit" class="btn-upload">ä¸Šä¼ è§†é¢‘åˆ†æ</button>
                </form>
                <div style="width: 1px; height: 20px; background: #555;"></div>
                <button onclick="resetCamera()" class="btn-reset">â†º åˆ‡å›æ‘„åƒå¤´</button>
            </div>

            <div class="video-box">
                <img id="videoStream" src="{{ url_for('video_feed') }}" alt="Live Feed">
                <div style="position: absolute; top: 10px; left: 10px; font-size: 12px; color: rgba(255,255,255,0.6); background: rgba(0,0,0,0.5); padding: 2px 5px; border-radius: 3px;">LIVE</div>
            </div>

            <div class="stats-bar">
                <div class="stat-item">å½“å‰ç”»é¢äººæ•°: <span id="curr-num">0</span></div>
                <div class="stat-item">ç´¯è®¡æ€» ID æ•°: <span id="total-count">0</span></div>
            </div>

            <div class="log-panel">
                <div class="log-header">
                    <span>âœ… ç†Ÿäººé€šè¡Œè®°å½•</span>
                    <button onclick="clearLogs()" style="background: transparent; border: none; color: #888; font-size: 0.8rem; cursor: pointer;">[æ¸…ç©ºè®°å½•]</button>
                </div>
                <div class="log-list" id="accessLogList">
                    <div style="text-align: center; color: #444; margin-top: 10px;">ç­‰å¾…é€šè¡Œæ•°æ®...</div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="panel-title">ğŸš© å¾…ç¡®è®¤é™Œç”Ÿäºº (åœç•™>5s)</div>
            <div class="pending-list" id="pendingList">
                <div style="text-align: center; color: #555; margin-top: 30px; font-size: 0.9rem;">
                    æš‚æ— å¾…å¤„ç†ç›®æ ‡...
                </div>
            </div>
        </div>

    </div>

    <script>
        const videoImg = document.getElementById('videoStream');

        // --- 1. è§†é¢‘æºæ§åˆ¶ ---
        document.getElementById('uploadForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "å¤„ç†ä¸­...";
            btn.disabled = true;

            const formData = new FormData(e.target);
            try {
                await fetch('/upload_video', { method: 'POST', body: formData });
                // å¼ºåˆ¶åˆ·æ–° img src
                videoImg.src = "{{ url_for('video_feed') }}?t=" + Date.now();
            } catch(err) {
                alert("ä¸Šä¼ å¤±è´¥");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        async function resetCamera() {
            await fetch('/reset_camera', { method: 'POST' });
            videoImg.src = "{{ url_for('video_feed') }}?t=" + Date.now();
        }

        // --- 2. åŸºç¡€æ•°æ®ç»Ÿè®¡ (1ç§’åˆ·æ–°) ---
        setInterval(async () => {
            try {
                const res = await fetch('/stats');
                const data = await res.json();
                document.getElementById('curr-num').innerText = data.current_num;
                document.getElementById('total-count').innerText = data.count;
            } catch(e) {}
        }, 1000);

        // --- 3. ç™½åå•æ—¥å¿— (1ç§’åˆ·æ–°) ---
        async function updateAccessLogs() {
            try {
                const res = await fetch('/get_access_logs');
                const logs = await res.json();
                const container = document.getElementById('accessLogList');

                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#444; margin-top:10px;">æš‚æ— è®°å½•...</div>';
                    return;
                }

                // ç›´æ¥é‡ç»˜æ—¥å¿—åˆ—è¡¨ (æ—¥å¿—åªéœ€å±•ç¤ºï¼Œæ— éœ€äº¤äº’)
                let html = '';
                logs.forEach(log => {
                    html += `
                        <div class="log-item">
                            <span class="log-name">ğŸ‘¤ ${log.name}</span>
                            <span class="log-time" style="font-size:0.8rem;">ID:${log.id} | ${log.time}</span>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {}
        }
        setInterval(updateAccessLogs, 1000);

        async function clearLogs() {
            await fetch('/clear_logs', { method: 'POST' });
            updateAccessLogs();
        }

        // --- 4. é™Œç”Ÿäººä»»åŠ¡åˆ—è¡¨ (æ™ºèƒ½å¢é‡æ›´æ–°) ---
        async function checkPendingFaces() {
            try {
                const res = await fetch('/get_pending_faces?t=' + Date.now());
                const files = await res.json();
                const container = document.getElementById('pendingList');

                // ç©ºçŠ¶æ€å¤„ç†
                if (files.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #555; margin-top: 30px; font-size: 0.9rem;">æš‚æ— å¾…å¤„ç†ç›®æ ‡...</div>';
                    return;
                }

                // å¦‚æœä¹‹å‰æ˜¯ç©ºçŠ¶æ€æç¤ºï¼Œå…ˆæ¸…ç©º
                if (container.innerText.includes('æš‚æ— å¾…å¤„ç†')) {
                    container.innerHTML = '';
                }

                const serverFileSet = new Set(files);

                // A. åˆ é™¤å·²è¿‡æœŸçš„å¡ç‰‡
                document.querySelectorAll('.stranger-card').forEach(card => {
                    const fname = card.getAttribute('data-filename');
                    if (!serverFileSet.has(fname)) {
                        card.remove();
                    }
                });

                // B. æ·»åŠ æ–°å¡ç‰‡ (ä¿æŒè¾“å…¥æ¡†çŠ¶æ€)
                files.forEach(file => {
                    if (!document.getElementById(`card-${file}`)) {
                        const trackId = file.split('_')[1] || '?';
                        const card = document.createElement('div');
                        card.className = 'stranger-card';
                        card.id = `card-${file}`;
                        card.setAttribute('data-filename', file);

                        card.innerHTML = `
                            <img src="/pending_img/${file}" onclick="window.open(this.src)">
                            <div class="stranger-info">
                                <span>Track ID: ${trackId}</span>
                                <span>Pending</span>
                            </div>
                            <input type="text" placeholder="è¾“å…¥å§“å (è‹±æ–‡)..." id="name-${file}" autocomplete="off">
                            <div class="btn-group">
                                <button class="btn-confirm" onclick="confirmPerson('${file}')">å…¥åº“</button>
                                <button class="btn-delete" onclick="deletePerson('${file}')">å¿½ç•¥</button>
                            </div>
                        `;
                        container.prepend(card);
                    }
                });

            } catch (e) { console.error(e); }
        }
        // 2ç§’åˆ·æ–°ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨
        setInterval(checkPendingFaces, 2000);

        // --- æŒ‰é’®æ“ä½œ ---
        // --- åœ¨ index.html çš„ script ä¸­æ›¿æ¢ confirmPerson ---

        async function confirmPerson(filename) {
            console.log("ç‚¹å‡»äº†å…¥åº“æŒ‰é’®:", filename); // F12 æ§åˆ¶å°çœ‹è¿™é‡Œ

            const nameInput = document.getElementById(`name-${filename}`);
            if (!nameInput) {
                alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¾“å…¥æ¡†ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                return;
            }

            const name = nameInput.value.trim();
            if (!name) {
                alert("è¯·è¾“å…¥å§“åï¼");
                return;
            }

            // æŒ‰é’®å˜è‰²ï¼Œæç¤ºç”¨æˆ·æ­£åœ¨å¤„ç†
            const btn = document.querySelector(`#card-${filename.replace('.', '\\.')} .btn-confirm`); // å¤„ç†æ–‡ä»¶åä¸­çš„ç‚¹
            if(btn) {
                btn.innerText = "å¤„ç†ä¸­...";
                btn.disabled = true;
            }

            try {
                const res = await fetch('/confirm_stranger', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filename, name })
                });

                const data = await res.json();
                console.log("åç«¯è¿”å›:", data); // F12 æ§åˆ¶å°çœ‹è¿™é‡Œ

                if(data.success) {
                    // æˆåŠŸï¼šæ‰‹åŠ¨ç§»é™¤å¡ç‰‡
                    const card = document.getElementById(`card-${filename}`);
                    if(card) card.remove();
                    // æç¤ºä¸€ä¸‹
                    console.log("å…¥åº“æˆåŠŸ");
                } else {
                    alert("å…¥åº“å¤±è´¥: " + (data.msg || "æœªçŸ¥é”™è¯¯"));
                    if(btn) {
                        btn.innerText = "å…¥åº“";
                        btn.disabled = false;
                    }
                }
            } catch (err) {
                console.error("è¯·æ±‚å‘é€å¤±è´¥:", err);
                alert("ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Python åå°æ˜¯å¦æŠ¥é”™");
                if(btn) {
                    btn.innerText = "å…¥åº“";
                    btn.disabled = false;
                }
            }
        }

        async function deletePerson(filename) {
            await fetch('/delete_stranger', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ filename })
            });
            // ç•Œé¢ä¸Šå¯ä»¥ç«‹å³ç§»é™¤ï¼Œå¢å¼ºåé¦ˆæ„Ÿ
            const card = document.getElementById(`card-${filename}`);
            if(card) card.remove();
        }

    </script>
</body>
</html>